/*
 This code Reads an analog signals from our gas sensor at pins A0 and   sends serial output to rpi through a handshaking process 
*/
 
const int analogInPin = A0;  // Analog input pin 
const int resValue = 9700;  // Value of 10kOhm resistor 
const float Vref = 1.1;  //voltage of the internal reference
const long int cOff = 68286; //offset due to resistor ladder 
const float PPM;   //PPM variable
const float Sf = 2.11; // sensitivity in nA/ppm
const int extraBit = 256; //Number of samples averaged
long int sensorValue = 0;        // value read from the sensor
float currentValue = 0;        // current read from the sensor
 
void setup() {
  // initialize serial communications at 19200 bps
  Serial.begin(19200);
  // set analog reference to 1.1 V
  analogReference(INTERNAL);
  
}
 
void loop() {
  // read the analog in value:
  sensorValue = 0;
  for (int i = 0; i < extraBit; i++) {
    sensorValue = analogRead(analogInPin) + sensorValue;
    delay(3);   // 2 ms delay    
  }
 
  sensorValue = sensorValue - cOff;   
  if (Serial.available() > 0)
  { 
    String data = Serial.readStringUntil('\n');
    if (data == "Module?"){ //Reads that the MRV is looking for the module
      Serial.println("COD"); // Tells the MRV what module it is
    }
    else if (data == "Recognized")
    {
    }
    else if (data == "Count?")
    {
//sends out PPM values
      Serial.print("PPM = ");
      Serial.print( ((float) sensorValue / extraBit / 1024 * Vref / resValue * 1000000000) / Sf);
    }
    else
    {
      Serial.println("Unrecognized Module"); //In case there is an issue with the connection
    }
  
  delay(218);  //1 second â€“ 3ms*256ms (each adc read)-14ms (for printing)= 218ms
  }
}
